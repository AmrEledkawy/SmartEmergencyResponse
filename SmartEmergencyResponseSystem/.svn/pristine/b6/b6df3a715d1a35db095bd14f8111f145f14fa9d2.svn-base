classdef GeManager < handle
    %GEMANAGER This class recieves positional data from the GeCommunicator
    %and updates the Google earth interface accordingly    
    
    properties (Access = protected)   
        
        GVudp;
        QCudp;
        FWudp;
        
        GVdata;
        QCdata;
        FWdata;
        
        IEwindow;
        updateTimer;
    end
    
    methods 
        function obj = GeManager()
            
            
            % Open ActiveX-Control from Microsoft-Internet-Explorer
            explorer = actxcontrol('Shell.Explorer.2',[0 0 805 645]);
            set(gcf, 'Position', [0 0 810 650])
            
            webpage = [pwd '/web/ge_interface.html'];
            Navigate(explorer, webpage); 
            obj.IEwindow = explorer.Document.parentWindow;     
        end
    end
    methods (Access = protected)
        function startUDP(obj)
                         
            GVport = 4201;
            QCport = 4202;            
            FWport = 4203;
            
            GeIP = '127.0.0.1';
            
            obj.GVudp = udp(GeIP,GVport);
            obj.QCudp = udp(GeIP,QCport);
            obj.FWudp = udp(GeIP,FWport);
            
             obj.GVudp.DatagramReceivedFcn = @obj.updateGV;
             obj.QCudp.DatagramReceivedFcn = @obj.updateQC;
             obj.FWudp.DatagramReceivedFcn = @obj.updateFW;
        end
        
        function delete(obj)
            fclose(obj.GVudp);
            fclose(obj.QCudp);
            fclose(obj.FWudp);
            disp(obj);
        end
        
        function updateGV(obj)
            data = fscanf(obj.GVudp);
            obj.GVdata = obj.parseUDP(data);
        end
        
        function updateQC(obj)
            data = fscanf(obj.QCudp);
            obj.QCdata = obj.parseUDP(data);
        end
                
        function updateFW(obj)
            data = fscanf(obj.GVudp);
            obj.FWdata = obj.parseUDP(data);
        end
        
        function out = parseUDP(~,data)
            dataStr = mat2str(data');
            dataCell = strsplit(dataStr(2:end-1),';');
            out = cellfun(dataCell,@(x) ['[' regexprep(x,' ',', ') ']']);
        end
        
        function updateGe(obj)
            
            View = 1;
            GV = obj.GVdata;
            QC = obj.QCdata;
            FW = obj.FWdata;
            obj.IEwindow.execScript(['move6GV(' GV{1} ',' GV{2} ',' GV{3} ',' GV{4} ',' GV{5} ',' GV{6} ')'], 'Jscript');
            obj.IEwindow.execScript(['move6AR(' QC{1} ',' QC{2} ',' QC{3} ',' QC{4} ',' QC{5} ',' QC{6} ')'], 'Jscript');
            obj.IEwindow.execScript(['move6FW(' FW{1} ',' FW{2} ',' FW{3} ',' FW{4} ',' FW{5} ',' FW{6} ')'], 'Jscript');
            obj.IEwindow.execScript(['synchronousUpdate(' num2str(View) ', 0, 0, 0, 0, 0)'], 'Jscript');
        end
    end
    
end

